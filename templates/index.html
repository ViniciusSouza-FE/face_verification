{% extends "base.html" %} {% block content %}
<div class="card">
  <div class="card-header">
    <h1><i class="fas fa-user-check"></i> Confirmação Facial</h1>
    <p>Identifique pessoas usando IA através de upload ou câmera</p>
  </div>

  <div class="card-body">
    <div class="grid grid-2 mobile-stack">
      <!-- Método 1: Upload de Arquivo -->
      <div class="method-card">
        <div class="method-icon">
          <i class="fas fa-file-upload"></i>
        </div>
        <h2>Upload de Imagem</h2>
        <p>Selecione uma foto dos seus arquivos para identificar a pessoa</p>

        <div class="form-group">
          <label class="form-label" for="documentoUpload">
            <i class="fas fa-id-card"></i> Número do Documento *
          </label>
          <input
            type="text"
            class="form-control"
            id="documentoUpload"
            required
            placeholder="Digite o número do documento"
          />
        </div>

        <div class="form-group">
          <div
            class="file-input"
            onclick="document.getElementById('fileInput').click()"
          >
            <i
              class="fas fa-cloud-upload-alt"
              style="font-size: 2rem; margin-bottom: 1rem"
            ></i>
            <p>Clique para selecionar uma imagem</p>
            <small>Formatos: JPG, PNG, GIF</small>
          </div>
          <input
            type="file"
            id="fileInput"
            accept="image/*"
            style="display: none"
          />
        </div>

        <button class="btn btn-primary" onclick="processUpload()">
          <i class="fas fa-search"></i> Confirmar Identidade
        </button>

        <div class="loading" id="uploadLoading">
          <div class="spinner"></div>
          <p>Processando imagem...</p>
        </div>
      </div>

      <!-- Método 2: Câmera -->
      <div class="method-card">
        <div class="method-icon">
          <i class="fas fa-camera"></i>
        </div>
        <h2>Usar Câmera</h2>
        <p>Capture uma foto usando a câmera do seu dispositivo</p>

        <div class="form-group">
          <label class="form-label" for="documentoCamera">
            <i class="fas fa-id-card"></i> Número do Documento *
          </label>
          <input
            type="text"
            class="form-control"
            id="documentoCamera"
            required
            placeholder="Digite o número do documento"
          />
        </div>

        <div class="mobile-stack">
          <button class="btn btn-primary" onclick="startCamera()">
            <i class="fas fa-camera"></i> Abrir Câmera
          </button>
          <input
            type="file"
            id="mobileCameraInput"
            accept="image/*"
            capture="environment"
            style="display: none"
          />
        </div>

        <div class="camera-container" id="cameraContainer">
          <video
            id="video"
            autoplay
            playsinline
            class="mobile-full-width"
          ></video>
          <img
            id="cameraPreviewImg"
            alt="Preview da foto"
            style="
              display: none;
              width: 100%;
              max-width: 100%;
              margin-top: 1rem;
              border-radius: 10px;
            "
          />
          <div class="mobile-stack" style="margin-top: 1rem">
            <button
              class="btn btn-success"
              id="captureBtn"
              onclick="capturePhoto()"
            >
              <i class="fas fa-camera"></i> Capturar Foto
            </button>
            <button
              class="btn btn-primary"
              id="cameraConfirmBtn"
              style="display: none"
              onclick="confirmCameraUpload()"
            >
              <i class="fas fa-check"></i> Confirmar Identidade
            </button>
            <button class="btn btn-secondary" onclick="stopCamera()">
              <i class="fas fa-times"></i> Fechar Câmera
            </button>
          </div>
        </div>

        <div class="loading" id="cameraLoading">
          <div class="spinner"></div>
          <p>Processando foto...</p>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div class="result-container" id="resultContainer">
      <h3 id="resultTitle"></h3>
      <div id="resultMessage"></div>
      <div id="resultPerson" style="margin: 1rem 0"></div>
      <div class="confidence-info">
        <div id="resultConfidence"></div>
        <p class="confidence-indicator" style="margin-top: 0.5rem">
          (Alta: ≥80% | Média: 60-79% | Baixa: <60%)
        </p>
        <div id="similarityWarning" style="margin-top: 1rem"></div>
      </div>
    </div>

    <div class="error-container" id="errorContainer">
      <h3><i class="fas fa-exclamation-circle"></i> Erro</h3>
      <p id="errorMessage"></p>
    </div>
  </div>
</div>

<style>
  .confidence-indicator {
    color: #666;
    font-style: italic;
    font-size: 0.9em;
  }

  .high-confidence {
    color: #28a745;
    font-weight: bold;
  }

  .medium-confidence {
    color: #ff9800;
    font-weight: bold;
  }

  .low-confidence {
    color: #dc3545;
    font-weight: bold;
  }

  #video,
  #cameraPreviewImg {
    width: 100%;
    max-width: 100%;
    border-radius: 10px;
    display: block;
    margin: 0 auto;
    height: auto;
    max-height: 50vh;
  }

  .result-container {
    transition: all 0.3s ease-in-out;
    border: 1px solid;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1.5rem 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  @media (max-width: 768px) {
    .method-card {
      margin-bottom: 1rem;
    }

    .mobile-stack {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .btn {
      margin-bottom: 0.5rem;
    }

    .result-container {
      padding: 1.25rem;
      margin: 1rem 0;
    }
  }

  @media (max-width: 480px) {
    .card-body {
      padding: 0.75rem;
    }

    .method-card {
      padding: 1rem;
    }

    .file-input {
      padding: 1rem;
    }

    .result-container {
      padding: 1rem;
    }
  }
</style>

<script>
  let stream = null;

  // Elementos DOM
  const video = document.getElementById("video");
  const cameraContainer = document.getElementById("cameraContainer");
  const fileInput = document.getElementById("fileInput");
  const uploadLoading = document.getElementById("uploadLoading");
  const cameraLoading = document.getElementById("cameraLoading");

  // Iniciar câmera
  async function startCamera() {
    if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      const mobileInput = document.getElementById("mobileCameraInput");
      mobileInput.value = null;
      mobileInput.click();
      return;
    }

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: "user",
        },
      });
      video.srcObject = stream;
      cameraContainer.style.display = "block";
    } catch (err) {
      showError("Erro ao acessar a câmera: " + err.message);
    }
  }

  // Parar câmera
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
      stream = null;
    }
    cameraContainer.style.display = "none";
  }

  // Capturar foto da câmera
  let lastCapturedDataUrl = null;
  function capturePhoto() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const context = canvas.getContext("2d");
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL("image/jpeg");
    lastCapturedDataUrl = imageData;

    const previewImg = document.getElementById("cameraPreviewImg");
    previewImg.src = imageData;
    previewImg.style.display = "block";

    document.getElementById("cameraConfirmBtn").style.display = "inline-flex";
  }

  // Envia a captura confirmada para reconhecimento
  async function confirmCameraUpload() {
    const documento = (
      document.getElementById("documentoCamera").value ||
      document.getElementById("documentoUpload").value ||
      ""
    ).trim();
    if (!documento) {
      showError("Por favor, informe o número do documento");
      return;
    }

    if (fileInput && fileInput.files && fileInput.files[0]) {
      showLoading(cameraLoading);
      hideResults();
      try {
        await processUpload();
      } catch (error) {
        showError("Erro ao enviar a foto: " + error.message);
      } finally {
        hideLoading(cameraLoading);
        stopCamera();
        const previewImg = document.getElementById("cameraPreviewImg");
        if (previewImg) previewImg.style.display = "none";
        document.getElementById("cameraConfirmBtn").style.display = "none";
      }
      return;
    }

    if (!lastCapturedDataUrl) {
      showError("Nenhuma foto capturada.");
      return;
    }

    showLoading(cameraLoading);
    hideResults();

    try {
      const res = await fetch(lastCapturedDataUrl);
      const blob = await res.blob();
      const file = new File([blob], "camera.jpg", { type: blob.type });

      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      await processUpload();
    } catch (error) {
      showError("Erro ao enviar a foto: " + error.message);
    } finally {
      hideLoading(cameraLoading);
      stopCamera();
      lastCapturedDataUrl = null;
      const previewImg = document.getElementById("cameraPreviewImg");
      if (previewImg) previewImg.style.display = "none";
      document.getElementById("cameraConfirmBtn").style.display = "none";
    }
  }

  // Processar upload de arquivo
  async function processUpload() {
    const file = fileInput.files[0];
    const documento = (
      document.getElementById("documentoUpload").value ||
      document.getElementById("documentoCamera").value ||
      ""
    ).trim();

    if (!documento) {
      showError("Por favor, informe o número do documento");
      return;
    }
    if (!file) {
      showError("Por favor, selecione uma imagem");
      return;
    }

    showLoading(uploadLoading);
    hideResults();

    const formData = new FormData();
    formData.append("file", file);
    formData.append("documento", documento);

    try {
      const response = await fetch("/api/recognize_upload", {
        method: "POST",
        body: formData,
      });

      const result = await response.json();
      handleRecognitionResult(result);
    } catch (error) {
      showError("Erro ao processar arquivo: " + error.message);
    } finally {
      hideLoading(uploadLoading);
    }
  }

  // Lidar com o resultado do reconhecimento
  function handleRecognitionResult(result) {
    if (result.error) {
      showError(result.error);
    } else if (result.success) {
      const confidence = result.confidence;
      let message, color, bgColor;

      if (confidence >= 80) {
        message = "Alta similaridade detectada!";
        color = "#28a745"; // Verde
        bgColor = "#e8f5e8"; // Verde mais claro
      } else if (confidence >= 60) {
        message = "Similaridade média detectada!";
        color = "#ff9800"; // Laranja/Amarelo
        bgColor = "#fff8e1"; // Amarelo claro
      } else {
        message = "Baixa similaridade detectada!";
        color = "#dc3545"; // Vermelho
        bgColor = "#fde8e8"; // Vermelho claro
      }

      showResult(
        message,
        confidence,
        result.person,
        confidence < 60,
        color,
        bgColor
      );
    } else {
      showError(result.message || "Pessoa não identificada na base de dados");
    }
  }

  function showResult(
    message,
    confidence,
    person,
    isLowSimilarity,
    color,
    bgColor
  ) {
    const resultContainer = document.getElementById("resultContainer");
    const errorContainer = document.getElementById("errorContainer");
    const resultTitle = document.getElementById("resultTitle");
    const resultMessage = document.getElementById("resultMessage");
    const resultPerson = document.getElementById("resultPerson");
    const resultConfidence = document.getElementById("resultConfidence");
    const similarityWarning = document.getElementById("similarityWarning");

    // Limpa mensagens anteriores
    resultMessage.textContent = "";

    // Informações da pessoa
    resultPerson.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <p><strong>Nome:</strong> ${person.nome}</p>
            ${
              person.email
                ? `<p><strong>Email:</strong> ${person.email}</p>`
                : ""
            }
            ${
              person.telefone
                ? `<p><strong>Telefone:</strong> ${person.telefone}</p>`
                : ""
            }
        </div>
    `;

    // Formata a confiança para 1 casa decimal
    const confidenceFormatted = parseFloat(confidence).toFixed(1);

    // Define o ícone, cor e estilo de acordo com a confiança
    let icon = "";
    let confidenceColor = "";
    let confidenceClass = "";

    if (confidence >= 80) {
      icon = "✓";
      confidenceColor = "#28a745"; // Verde
      confidenceClass = "high-confidence";
      resultTitle.innerHTML =
        '<i class="fas fa-check-circle"></i> Alta Similaridade Detectada!';
    } else if (confidence >= 60) {
      icon = "⚠";
      confidenceColor = "#ff9800"; // Laranja/Amarelo mais vibrante
      confidenceClass = "medium-confidence";
      resultTitle.innerHTML =
        '<i class="fas fa-exclamation-triangle"></i> Similaridade Média Detectada!';
    } else {
      icon = "✗";
      confidenceColor = "#dc3545"; // Vermelho
      confidenceClass = "low-confidence";
      resultTitle.innerHTML =
        '<i class="fas fa-times-circle"></i> Baixa Similaridade Detectada!';
    }

    // Aplica as cores ao título
    resultTitle.style.color = confidenceColor;

    // Atualiza a exibição da confiança com ícone
    resultConfidence.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin: 1rem 0;">
            <span style="font-size: 1.1rem; font-weight: 600;">Confiança:</span>
            <span style="color: ${confidenceColor}; font-weight: bold; font-size: 1.3em; background: ${confidenceColor}15; padding: 0.5rem 1rem; border-radius: 8px; border-left: 4px solid ${confidenceColor};">
                ${confidenceFormatted}% 
                <span style="margin-left: 8px; font-size: 1.2em;">${icon}</span>
            </span>
        </div>
    `;

    // Mensagem de warning para baixa similaridade
    if (isLowSimilarity) {
      similarityWarning.style.display = "block";
      similarityWarning.innerHTML = `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 0.75rem; margin-top: 1rem;">
                <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                <strong style="color: #856404; margin-left: 0.5rem;">Atenção:</strong> 
                <span style="color: #856404; margin-left: 0.25rem;">Similaridade abaixo do ideal. Recomenda-se verificação adicional.</span>
            </div>
        `;
    } else {
      similarityWarning.style.display = "none";
    }

    // Aplica cor de fundo e borda ao container de resultados
    resultContainer.style.backgroundColor = bgColor;
    resultContainer.style.borderColor = color;
    resultContainer.style.borderLeft = `5px solid ${color}`;
    resultContainer.style.display = "block";

    // Esconde container de erro
    errorContainer.style.display = "none";

    // Scroll suave para o resultado
    setTimeout(() => {
      resultContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }, 100);
  }

  // Event listener para mudança de arquivo
  fileInput.addEventListener("change", function () {
    if (this.files[0]) {
      const fileName = this.files[0].name;
      const truncated =
        fileName.length > 40
          ? fileName.slice(0, 20) + "..." + fileName.slice(-15)
          : fileName;
      document.querySelector(
        ".file-input p"
      ).innerHTML = `Arquivo selecionado: <span class="file-name">${truncated}</span>`;
    }
    hideResults();
  });

  // Mobile camera input
  const mobileCameraInput = document.getElementById("mobileCameraInput");
  if (mobileCameraInput) {
    mobileCameraInput.addEventListener("change", function () {
      if (this.files && this.files[0]) {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(this.files[0]);
        fileInput.files = dataTransfer.files;

        const reader = new FileReader();
        reader.onload = function (e) {
          const previewImg = document.getElementById("cameraPreviewImg");
          previewImg.src = e.target.result;
          previewImg.style.display = "block";
          document.getElementById("cameraConfirmBtn").style.display =
            "inline-flex";
          const camContainer = document.getElementById("cameraContainer");
          if (camContainer) camContainer.style.display = "block";
          try {
            previewImg.scrollIntoView({ behavior: "smooth", block: "center" });
          } catch (e) {}
        };
        reader.readAsDataURL(this.files[0]);

        const fileName = this.files[0].name;
        const truncated =
          fileName.length > 40
            ? fileName.slice(0, 20) + "..." + fileName.slice(-15)
            : fileName;
        document.querySelector(
          ".file-input p"
        ).innerHTML = `Foto capturada: <span class="file-name">${truncated}</span>`;
        hideResults();
      }
    });
  }

  // Funções utilitárias
  function showLoading(loadingElement) {
    if (loadingElement) loadingElement.style.display = "block";
  }

  function hideLoading(loadingElement) {
    if (loadingElement) loadingElement.style.display = "none";
  }

  function showError(message) {
    const errorContainer = document.getElementById("errorContainer");
    const errorMessage = document.getElementById("errorMessage");
    if (errorContainer && errorMessage) {
      errorMessage.textContent = message;
      errorContainer.style.display = "block";
      const resultContainer = document.getElementById("resultContainer");
      if (resultContainer) resultContainer.style.display = "none";
    } else {
      alert("Erro: " + message);
    }
  }

  function hideResults() {
    const resultContainer = document.getElementById("resultContainer");
    const errorContainer = document.getElementById("errorContainer");
    if (resultContainer) resultContainer.style.display = "none";
    if (errorContainer) errorContainer.style.display = "none";
  }
</script>
{% endblock %}
