{% extends "base.html" %} {% block content %}
<div class="card">
  <div class="card-header">
    <h1><i class="fas fa-user-plus"></i> Cadastrar Nova Pessoa</h1>
    <p>Adicione novas pessoas ao sistema de confirmação facial</p>
  </div>

  <div class="card-body">
    <form id="cadastroForm" enctype="multipart/form-data">
      <div class="grid grid-2">
        <div>
          <div class="form-group">
            <label class="form-label" for="nome">
              <i class="fas fa-user"></i> Nome Completo *
            </label>
            <input
              type="text"
              class="form-control"
              id="nome"
              name="nome"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="documento">
              <i class="fas fa-id-card"></i> Número do Documento *
            </label>
            <input
              type="text"
              class="form-control"
              id="documento"
              name="documento"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="email">
              <i class="fas fa-envelope"></i> Email
            </label>
            <input type="email" class="form-control" id="email" name="email" />
          </div>

          <div class="form-group">
            <label class="form-label" for="telefone">
              <i class="fas fa-phone"></i> Telefone
            </label>
            <input
              type="tel"
              class="form-control"
              id="telefone"
              name="telefone"
            />
          </div>
        </div>

        <div>
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-camera"></i> Foto para Extração de Embedding *
            </label>
            
            <!-- Botões de escolha do método -->
            <div style="margin-bottom: 1rem; text-align: center;">
              <button type="button" class="btn btn-secondary" onclick="toggleUploadMethod('file')" id="btnFile">
                <i class="fas fa-file-upload"></i> Upload de Arquivo
              </button>
              <button type="button" class="btn btn-secondary" onclick="toggleUploadMethod('camera')" id="btnCamera">
                <i class="fas fa-camera"></i> Usar Câmera
              </button>
            </div>

            <!-- Área de Upload -->
            <div id="fileUploadArea">
              <div
                class="file-input"
                onclick="document.getElementById('foto').click()"
                style="
                  height: 200px;
                  display: flex;
                  flex-direction: column;
                  justify-content: center;
                "
              >
                <i
                  class="fas fa-cloud-upload-alt"
                  style="font-size: 3rem; margin-bottom: 1rem"
                ></i>
                <p id="fileLabel">Clique para selecionar uma foto</p>
                <small>Formatos: JPG, PNG, GIF (máx 2MB)</small>
              </div>
              <input
                type="file"
                id="foto"
                name="foto"
                accept="image/*"
                style="display: none"
                required
              />
            </div>

            <!-- Área da Câmera -->
            <div id="cameraArea" style="display: none; text-align: center;">
              <video id="video" autoplay playsinline style="width: 100%; max-width: 400px; border-radius: 10px;"></video>
              <div style="margin-top: 1rem;">
                <button type="button" class="btn btn-success" onclick="capturarFoto()">
                  <i class="fas fa-camera"></i> Capturar Foto
                </button>
              </div>
              <canvas id="canvas" style="display: none;"></canvas>
            </div>
          </div>

          <div
            id="imagePreview"
            style="display: none; text-align: center; margin-top: 1rem"
          >
            <img
              id="preview"
              style="max-width: 200px; max-height: 200px; border-radius: 10px"
            />
            <div style="margin-top: 0.5rem;">
              <button type="button" class="btn btn-danger" onclick="removerFoto()">
                <i class="fas fa-trash"></i> Remover Foto
              </button>
            </div>
          </div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 2rem">
        <button
          type="submit"
          class="btn btn-primary"
          style="padding: 1rem 2rem"
          id="submitBtn"
        >
          <i class="fas fa-save"></i> Cadastrar Pessoa
        </button>
      </div>
    </form>

    <div class="loading" id="cadastroLoading">
      <div class="spinner"></div>
      <p>Processando imagem e cadastrando...</p>
      <small>Isso pode levar alguns segundos</small>
    </div>

    <div class="result-container" id="cadastroSuccess" style="display: none">
      <h3><i class="fas fa-check-circle"></i> Cadastro Realizado!</h3>
      <p id="successMessage"></p>
    </div>

    <div class="error-container" id="cadastroError" style="display: none">
      <h3><i class="fas fa-exclamation-circle"></i> Erro no Cadastro</h3>
      <p id="errorMessage"></p>
    </div>
  </div>
</div>

<script>
  const fotoInput = document.getElementById("foto");
  const imagePreview = document.getElementById("imagePreview");
  const preview = document.getElementById("preview");
  const fileLabel = document.getElementById("fileLabel");
  const form = document.getElementById("cadastroForm");
  const loading = document.getElementById("cadastroLoading");
  const successDiv = document.getElementById("cadastroSuccess");
  const errorDiv = document.getElementById("cadastroError");
  const submitBtn = document.getElementById("submitBtn");
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  let stream = null;

  // Preview da imagem selecionada
  fotoInput.addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      // Verifica tamanho do arquivo (máx 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showCadastroError("A imagem deve ter no máximo 2MB");
        this.value = "";
        return;
      }

      fileLabel.textContent = file.name;
      const reader = new FileReader();

      reader.onload = function (e) {
        preview.src = e.target.result;
        imagePreview.style.display = "block";
      };

      reader.readAsDataURL(file);
    } else {
      fileLabel.textContent = "Clique para selecionar uma foto";
      imagePreview.style.display = "none";
    }
  });

  // Submissão do formulário
  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(this);

    // Validações
    if (!formData.get("nome")) {
      showCadastroError("Nome é obrigatório");
      return;
    }

    if (!formData.get("foto")) {
      showCadastroError("Foto é obrigatória");
      return;
    }

    // Desabilita o botão para evitar múltiplos cliques
    submitBtn.disabled = true;
    submitBtn.innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> Processando...';

    loading.style.display = "block";
    successDiv.style.display = "none";
    errorDiv.style.display = "none";

    try {
      const response = await fetch("/api/cadastrar_pessoa", {
        method: "POST",
        body: formData,
      });

      // Verifica se a resposta é JSON válido
      const text = await response.text();
      let result;

      try {
        result = JSON.parse(text);
      } catch (parseError) {
        console.error("Resposta não é JSON válido:", text);
        throw new Error("Resposta inválida do servidor. Tente novamente.");
      }

      if (result.success) {
        showCadastroSuccess(result.message);
        form.reset();
        imagePreview.style.display = "none";
        fileLabel.textContent = "Clique para selecionar uma foto";
      } else {
        showCadastroError(result.error || "Erro desconhecido");
      }
    } catch (error) {
      console.error("Erro no cadastro:", error);
      showCadastroError("Erro ao cadastrar: " + error.message);
    } finally {
      loading.style.display = "none";
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save"></i> Cadastrar Pessoa';
    }
  });

  function showCadastroSuccess(message) {
    document.getElementById("successMessage").textContent = message;
    successDiv.style.display = "block";
    errorDiv.style.display = "none";
  }

  function showCadastroError(message) {
    document.getElementById("errorMessage").textContent = message;
    errorDiv.style.display = "block";
    successDiv.style.display = "none";
  }

  // Funções para a câmera
  async function iniciarCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: "user"
        }
      });
      video.srcObject = stream;
    } catch (err) {
      showCadastroError("Erro ao acessar a câmera: " + err.message);
    }
  }

  function pararCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }

  function toggleUploadMethod(method) {
    const fileArea = document.getElementById('fileUploadArea');
    const cameraArea = document.getElementById('cameraArea');
    const btnFile = document.getElementById('btnFile');
    const btnCamera = document.getElementById('btnCamera');

    if (method === 'file') {
      fileArea.style.display = 'block';
      cameraArea.style.display = 'none';
      btnFile.classList.add('btn-primary');
      btnFile.classList.remove('btn-secondary');
      btnCamera.classList.add('btn-secondary');
      btnCamera.classList.remove('btn-primary');
      pararCamera();
    } else {
      fileArea.style.display = 'none';
      cameraArea.style.display = 'block';
      btnCamera.classList.add('btn-primary');
      btnCamera.classList.remove('btn-secondary');
      btnFile.classList.add('btn-secondary');
      btnFile.classList.remove('btn-primary');
      iniciarCamera();
    }
  }

  function capturarFoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0);
    const imageData = canvas.toDataURL('image/jpeg');
    
    // Converter base64 para arquivo
    fetch(imageData)
      .then(res => res.blob())
      .then(blob => {
        const file = new File([blob], "camera-photo.jpg", { type: "image/jpeg" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fotoInput.files = dataTransfer.files;
        
        preview.src = imageData;
        imagePreview.style.display = "block";
        pararCamera();
        toggleUploadMethod('file');
      });
  }

  function removerFoto() {
    fotoInput.value = '';
    preview.src = '';
    imagePreview.style.display = 'none';
    fileLabel.textContent = 'Clique para selecionar uma foto';
  }

  // Limpar a câmera quando a página for fechada
  window.addEventListener('beforeunload', pararCamera);
</script>
{% endblock %}
