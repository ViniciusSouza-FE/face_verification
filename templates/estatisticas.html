{% extends "base.html" %} {% block content %}
<div class="card">
  <div class="card-header">
    <h1><i class="fas fa-chart-bar"></i> Estatísticas do Sistema</h1>
    <p>Relatórios e métricas do sistema de confirmação facial</p>
  </div>

  <div class="card-body">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Carregando estatísticas...</p>
    </div>

    <div id="estatisticasContent" style="display: none">
      <!-- Cards de Resumo -->
      <div class="grid grid-4 mobile-stack">
        <div class="stats-card">
          <div class="stats-icon">
            <i
              class="fas fa-users"
              style="font-size: 1.75rem; color: #4361ee"
            ></i>
          </div>
          <div class="stats-number" id="totalPessoas">0</div>
          <div class="stats-label">Pessoas Cadastradas</div>
        </div>

        <div class="stats-card">
          <div class="stats-icon">
            <i
              class="fas fa-search"
              style="font-size: 1.75rem; color: #7209b7"
            ></i>
          </div>
          <div class="stats-number" id="totalReconhecimentos">0</div>
          <div class="stats-label">Total de Confirmações</div>
        </div>

        <div class="stats-card">
          <div class="stats-icon">
            <i
              class="fas fa-camera"
              style="font-size: 1.75rem; color: #4cc9f0"
            ></i>
          </div>
          <div class="stats-number" id="reconhecimentosCamera">0</div>
          <div class="stats-label">Por Câmera</div>
        </div>

        <div class="stats-card">
          <div class="stats-icon">
            <i
              class="fas fa-upload"
              style="font-size: 1.75rem; color: #f8961e"
            ></i>
          </div>
          <div class="stats-number" id="reconhecimentosUpload">0</div>
          <div class="stats-label">Por Upload</div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="grid grid-2 mobile-stack" style="margin-top: 1.5rem">
        <div class="chart-container">
          <h3><i class="fas fa-chart-pie"></i> Confirmações por Método</h3>
          <div style="position: relative; height: 300px; width: 100%">
            <canvas id="metodoChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <h3>
            <i class="fas fa-chart-line"></i> Confirmações (Últimos 7 Dias)
          </h3>
          <div style="position: relative; height: 300px; width: 100%">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="error-container" id="errorContainer" style="display: none">
      <h3><i class="fas fa-exclamation-circle"></i> Erro</h3>
      <p id="errorMessage"></p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let metodoChart = null;
  let timelineChart = null;
  let estatisticasCarregadas = false;

  async function loadEstatisticas() {
    // Evita múltiplas chamadas simultâneas
    if (estatisticasCarregadas) return;

    const loading = document.getElementById("loading");
    const content = document.getElementById("estatisticasContent");
    const errorContainer = document.getElementById("errorContainer");

    loading.style.display = "block";
    content.style.display = "none";
    errorContainer.style.display = "none";

    try {
      const response = await fetch("/api/estatisticas");
      const data = await response.json();

      if (data.error) {
        throw new Error(data.error);
      }

      // Atualiza os cards
      document.getElementById("totalPessoas").textContent = data.total_pessoas;
      document.getElementById("totalReconhecimentos").textContent =
        data.total_reconhecimentos;
      document.getElementById("reconhecimentosCamera").textContent =
        data.reconhecimentos_metodo.camera || 0;
      document.getElementById("reconhecimentosUpload").textContent =
        data.reconhecimentos_metodo.upload || 0;

      // Cria gráfico de métodos
      createMetodoChart(data.reconhecimentos_metodo);

      // Cria gráfico de timeline
      createTimelineChart(data.reconhecimentos_7_dias);

      content.style.display = "block";
      estatisticasCarregadas = true;
    } catch (error) {
      document.getElementById("errorMessage").textContent =
        "Erro ao carregar estatísticas: " + error.message;
      errorContainer.style.display = "block";
    } finally {
      loading.style.display = "none";
    }
  }

  function createMetodoChart(metodoData) {
    const ctx = document.getElementById("metodoChart");
    if (!ctx) return;

    // Destrói gráfico existente
    if (metodoChart) {
      metodoChart.destroy();
    }

    const labels = Object.keys(metodoData).map((key) =>
      key === "camera" ? "Câmera" : "Upload"
    );
    const values = Object.values(metodoData);

    // Verifica se há dados para mostrar
    const total = values.reduce((sum, value) => sum + value, 0);
    if (total === 0) {
      ctx.style.display = "none";
      ctx.closest(".chart-container").innerHTML += `
        <div style="text-align: center; padding: 2rem; color: #666;">
          <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem;"></i>
          <p>Nenhum dado disponível para exibir</p>
        </div>
      `;
      return;
    }

    metodoChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [
          {
            data: values,
            backgroundColor: ["#4361ee", "#4cc9f0"],
            borderWidth: 2,
            borderColor: "#fff",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              padding: 20,
              usePointStyle: true,
            },
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const label = context.label || "";
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              },
            },
          },
        },
        animation: {
          animateScale: true,
          animateRotate: true,
        },
      },
    });
  }

  function createTimelineChart(timelineData) {
    const ctx = document.getElementById("timelineChart");
    if (!ctx) return;

    // Destrói gráfico existente
    if (timelineChart) {
      timelineChart.destroy();
    }

    const labels = Object.keys(timelineData);
    const values = Object.values(timelineData);

    // Verifica se há dados para mostrar
    const hasData = values.some((value) => value > 0);
    if (!hasData) {
      ctx.style.display = "none";
      ctx.closest(".chart-container").innerHTML += `
        <div style="text-align: center; padding: 2rem; color: #666;">
          <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem;"></i>
          <p>Nenhum dado disponível para exibir</p>
        </div>
      `;
      return;
    }

    timelineChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Confirmações por Dia",
            data: values,
            borderColor: "#7209b7",
            backgroundColor: "rgba(114, 9, 183, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: "#7209b7",
            pointBorderColor: "#fff",
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
            },
            grid: {
              color: "rgba(0, 0, 0, 0.1)",
            },
          },
          x: {
            grid: {
              color: "rgba(0, 0, 0, 0.1)",
            },
          },
        },
        plugins: {
          legend: {
            display: true,
            position: "top",
          },
        },
        interaction: {
          intersect: false,
          mode: "index",
        },
        animation: {
          duration: 1000,
        },
      },
    });
  }

  // Carrega as estatísticas quando a página é aberta
  document.addEventListener("DOMContentLoaded", function () {
    // Pequeno delay para garantir que o DOM esteja totalmente renderizado
    setTimeout(loadEstatisticas, 100);
  });

  // Recarrega quando a visibilidade da página muda (quando o usuário volta para a aba)
  document.addEventListener("visibilitychange", function () {
    if (!document.hidden) {
      // Recarrega estatísticas após 2 segundos quando a página se torna visível
      setTimeout(loadEstatisticas, 2000);
    }
  });

  // Atualiza a cada 60 segundos (aumentado para evitar sobrecarga)
  setInterval(loadEstatisticas, 60000);

  // Recarrega quando a janela é redimensionada (com debounce)
  let resizeTimeout;
  window.addEventListener("resize", function () {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function () {
      if (metodoChart) {
        metodoChart.resize();
      }
      if (timelineChart) {
        timelineChart.resize();
      }
    }, 250);
  });
</script>

<style>
  /* Estilos específicos para os gráficos */
  .chart-container {
    position: relative;
    min-height: 300px;
  }

  .chart-container canvas {
    max-width: 100%;
    height: auto !important;
  }

  @media (max-width: 768px) {
    .chart-container {
      min-height: 250px;
    }
  }
</style>
{% endblock %}
